<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Agentic Honeypot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(20, 20, 35, 0.85);
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.3);
            --danger: #ef4444;
            --success: #22c55e;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --scammer-bg: rgba(239, 68, 68, 0.12);
            --scammer-border: rgba(239, 68, 68, 0.25);
            --agent-bg: rgba(34, 197, 94, 0.10);
            --agent-border: rgba(34, 197, 94, 0.25);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* â•â•â• Animated background â•â•â• */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 20% 50%, rgba(245, 158, 11, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(239, 68, 68, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(34, 197, 94, 0.04) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes bgShift {

            0%,
            100% {
                transform: translate(0, 0)
            }

            50% {
                transform: translate(-3%, 2%)
            }
        }

        .app {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            padding: 16px;
        }

        /* â•â•â• Header â•â•â• */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            margin-bottom: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .header-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .header-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* â•â•â• Mode Toggle â•â•â• */
        .mode-toggle {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .mode-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn.active {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .mode-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.06);
        }

        /* â•â•â• Status Bar â•â•â• */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 10px 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-val {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* â•â•â• Chat Area â•â•â• */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            margin-bottom: 12px;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .msg {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.6;
            animation: msgIn 0.3s ease-out;
            position: relative;
        }

        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.scammer {
            background: var(--scammer-bg);
            border: 1px solid var(--scammer-border);
            border-bottom-left-radius: 4px;
            margin-right: auto;
        }

        .msg.agent {
            background: var(--agent-bg);
            border: 1px solid var(--agent-border);
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }

        .msg-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .msg.scammer .msg-label {
            color: var(--danger);
        }

        .msg.agent .msg-label {
            color: var(--success);
        }

        .msg-text {
            color: var(--text-primary);
        }

        .msg-meta {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            display: flex;
            gap: 12px;
        }

        .typing-indicator {
            display: none;
            max-width: 80%;
            margin-left: auto;
            padding: 14px 18px;
            background: var(--agent-bg);
            border: 1px solid var(--agent-border);
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            margin-bottom: 10px;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 7px;
            height: 7px;
            background: var(--success);
            border-radius: 50%;
            animation: typeBounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typeBounce {

            0%,
            60%,
            100% {
                transform: translateY(0)
            }

            30% {
                transform: translateY(-6px)
            }
        }

        /* â•â•â• Input Area â•â•â• */
        .input-area {
            display: flex;
            gap: 10px;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
        }

        .input-area input {
            flex: 1;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border 0.3s;
        }

        .input-area input:focus {
            border-color: var(--accent);
        }

        .input-area input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: #000;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* â•â•â• Voice Mode â•â•â• */
        .voice-area {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 40px 18px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
        }

        .voice-area.show {
            display: flex;
        }

        .mic-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--glass-border);
            background: var(--glass);
            color: var(--text-primary);
            font-size: 36px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mic-btn:hover {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.1);
        }

        .mic-btn.recording {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.15);
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3);
            }

            50% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }

        .mic-btn.speaking {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
            animation: micPulse2 1s infinite;
        }

        @keyframes micPulse2 {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.3);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
            }
        }

        .voice-status {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
        }

        .voice-transcript {
            width: 100%;
            max-width: 600px;
            min-height: 60px;
            padding: 16px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-primary);
            text-align: center;
            line-height: 1.6;
        }

        /* â•â•â• Intel Panel â•â•â• */
        .intel-panel {
            display: none;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            margin-bottom: 12px;
        }

        .intel-panel.show {
            display: block;
        }

        .intel-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .intel-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .intel-tag {
            padding: 4px 10px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 20px;
            font-size: 11px;
            color: var(--accent);
            font-weight: 500;
        }

        /* â•â•â• Empty State â•â•â• */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 16px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 14px;
            text-align: center;
            line-height: 1.6;
        }

        .empty-hint {
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* â•â•â• Modal â•â•â• */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: rgba(20, 20, 35, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            padding: 28px;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.6);
            transform: scale(0.9) translateY(10px);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.12);
        }

        .modal-sub {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 22px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* â•â•â• Select / Dropdown Styling â•â•â• */
        select.form-input {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
            padding-right: 36px;
            cursor: pointer;
        }

        select.form-input option {
            background: #1a1a2e;
            color: var(--text-primary);
            padding: 10px 14px;
            font-size: 14px;
        }

        select.form-input option:hover,
        select.form-input option:checked {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent);
        }

        /* â•â•â• JSON Intel Panel â•â•â• */
        .json-intel-panel {
            display: none;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            backdrop-filter: blur(20px);
            margin-bottom: 12px;
            max-height: 250px;
            overflow-y: auto;
        }

        .json-intel-panel.show {
            display: block;
        }

        .json-intel-panel::-webkit-scrollbar {
            width: 6px;
        }

        .json-intel-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .json-intel-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .json-intel-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #60a5fa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .json-intel-content {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #a5f3fc;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), #d97706);
            color: #000;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .header-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* â•â•â• Responsive â•â•â• */
        @media (max-width: 640px) {
            .app {
                padding: 8px;
            }

            .header {
                padding: 12px 14px;
            }

            .msg {
                max-width: 90%;
            }

            .modal {
                max-width: 100%;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- Persona Modal -->
    <div class="modal-overlay" id="personaModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ­ Configure Persona</div>
                <button type="button" class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-sub">Define the profile the AI will act as.</div>

            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="pName" placeholder="e.g. Tejash S">
            </div>
            <div class="form-group" style="display:flex; gap:12px;">
                <div style="flex:1">
                    <label class="form-label">Age</label>
                    <input type="text" class="form-input" id="pAge" placeholder="28">
                </div>
                <div style="flex:1">
                    <label class="form-label">Bank</label>
                    <input type="text" class="form-input" id="pBank" placeholder="SBI">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Occupation</label>
                <input type="text" class="form-input" id="pJob" placeholder="Software Engineer">
            </div>
            <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="pLoc" placeholder="e.g. Perundurai">
            </div>
            <div class="form-group" style="display:flex; gap:12px;">
                <div style="flex:1">
                    <label class="form-label">Gender</label>
                    <select class="form-input" id="pGender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label class="form-label">Language</label>
                    <select class="form-input" id="pLang">
                        <option value="English">English</option>
                        <option value="Tamil">Tamil</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Telugu">Telugu</option>
                        <option value="Kannada">Kannada</option>
                        <option value="Malayalam">Malayalam</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn-primary" onclick="savePersona()">Save &amp; Start</button>
        </div>
    </div>

    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-icon">ğŸ¯</div>
                <div>
                    <div class="header-title">Agentic Honeypot</div>
                    <div class="header-sub">AI Scam Intelligence System</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
                <div class="mode-toggle">
                    <button type="button" class="mode-btn active" id="msgModeBtn" onclick="switchMode('message')">ğŸ’¬ Message</button>
                    <button type="button" class="mode-btn" id="voiceModeBtn" onclick="switchMode('voice')">ğŸ™ï¸ Voice</button>
                </div>
                <button type="button" class="header-btn" id="endSessionBtn" onclick="endSession()" title="End Session &amp; Save to DB" style="color: var(--danger); font-size: 15px;">â¹</button>
                <a href="/admin" class="header-btn" title="Admin Dashboard" style="text-decoration:none; font-size: 15px;">ğŸ“Š</a>
                <button type="button" class="header-btn" onclick="openSettings()" title="Configure Persona">âš™ï¸</button>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-dot"></div>
            <span>Honeypot Active</span>
            <div class="stat">Messages: <span class="stat-val" id="msgCount">0</span></div>
            <div class="stat">Scam: <span class="stat-val" id="scamStatus">â€”</span></div>
            <div class="stat">Confidence: <span class="stat-val" id="confVal">â€”</span></div>
            <div class="stat">Type: <span class="stat-val" id="scamType">â€”</span></div>
        </div>

        <!-- Intel Panel -->
        <div class="intel-panel" id="intelPanel">
            <div class="intel-title">ğŸ” Extracted Intelligence</div>
            <div class="intel-grid" id="intelGrid"></div>
        </div>

        <!-- JSON Intelligence Panel -->
        <div class="json-intel-panel" id="jsonIntelPanel">
            <div class="json-intel-title">ğŸ“‹ Intelligence JSON</div>
            <div class="json-intel-content" id="jsonIntelContent">No data yet...</div>
        </div>

        <!-- Chat (Message Mode) -->
        <div class="chat-container" id="chatContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ•µï¸</div>
                <div class="empty-text">
                    Start a conversation as a scammer.<br>
                    The AI honeypot (<span id="agentNameDisplay">Priya</span>) will engage you.
                </div>
                <div class="empty-hint">Try: "Your SBI account has been compromised"</div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="msg-label" style="color: var(--success);"><span id="typingName">Priya</span> is typing...
                </div>
                <div class="typing-dots"><span></span><span></span><span></span></div>
            </div>
        </div>

        <!-- Voice Mode -->
        <div class="voice-area" id="voiceArea">
            <div class="voice-status" id="voiceStatus">Tap the mic to start speaking</div>
            <button type="button" class="mic-btn" id="micBtn" onclick="toggleMic()">ğŸ¤</button>
            <div class="voice-transcript" id="voiceTranscript">
                <span style="color: var(--text-muted)">Your speech will appear here...</span>
            </div>
        </div>

        <!-- Input (Message Mode) -->
        <div class="input-area" id="inputArea">
            <input type="text" id="msgInput" placeholder="Type a scam message..." autocomplete="off">
            <button type="button" class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Configuration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const API_BASE = window.location.origin;
        const API_KEY = 'fae26946fc2015d9bd6f1ddbb447e2f7';
        let sessionId = 'session-' + Date.now();
        let conversationHistory = [];
        let messageCount = 0;
        let currentMode = 'message';
        let isRecording = false;
        let isSpeaking = false;
        let recognition = null;

        // Default Persona
        let persona = {
            name: "Tejash S",
            age: "28",
            occupation: "Software Engineer",
            location: "Perundurai",
            bank: "SBI",
            gender: "Male",
            language: "English"
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Persona Management
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadPersona() {
            const saved = localStorage.getItem('honeypot_persona');
            if (saved) {
                try {
                    persona = JSON.parse(saved);
                } catch (e) { console.error(e); }
            }
            updatePersonaUI();
        }

        function updatePersonaUI() {
            const firstName = persona.name.split(' ')[0];
            const nameEls = document.querySelectorAll('#agentNameDisplay, #typingName');
            nameEls.forEach(el => { if (el) el.textContent = firstName; });

            // Also update empty state hint if visible
            const hint = document.querySelector('.empty-hint');
            if (hint) hint.textContent = `Try: "Your ${persona.bank} account has been compromised"`;
        }

        function openSettings() {
            document.getElementById('pName').value = persona.name || '';
            document.getElementById('pAge').value = persona.age || '';
            document.getElementById('pJob').value = persona.occupation || '';
            document.getElementById('pLoc').value = persona.location || '';
            document.getElementById('pBank').value = persona.bank || '';
            document.getElementById('pGender').value = persona.gender || 'Male';
            document.getElementById('pLang').value = persona.language || 'English';

            const modal = document.getElementById('personaModal');
            modal.style.display = 'flex';
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.add('show');
        }

        function closeSettings() {
            const modal = document.getElementById('personaModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function savePersona() {
            persona = {
                name: document.getElementById('pName').value || "Tejash S",
                age: document.getElementById('pAge').value || "28",
                occupation: document.getElementById('pJob').value || "Software Engineer",
                location: document.getElementById('pLoc').value || "Perundurai",
                bank: document.getElementById('pBank').value || "SBI",
                gender: document.getElementById('pGender').value || "Male",
                language: document.getElementById('pLang').value || "English"
            };

            localStorage.setItem('honeypot_persona', JSON.stringify(persona));
            updatePersonaUI();
            closeSettings();

            // Reset session
            sessionId = 'session-' + Date.now();
            conversationHistory = [];
            const firstName = persona.name.split(' ')[0];

            document.getElementById('chatContainer').innerHTML = `
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">ğŸ•µï¸</div>
                    <div class="empty-text">
                        Start a conversation as a scammer.<br>
                        The AI honeypot (<span id="agentNameDisplay">${firstName}</span>) will engage you.
                    </div>
                    <div class="empty-hint">Try: "Your ${persona.bank} account has been compromised"</div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="msg-label" style="color: var(--success);"><span id="typingName">${firstName}</span> is typing...</div>
                    <div class="typing-dots"><span></span><span></span><span></span></div>
                </div>
            `;
        }

        // Init
        window.addEventListener('DOMContentLoaded', loadPersona);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Mode Switching
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('msgModeBtn').classList.toggle('active', mode === 'message');
            document.getElementById('voiceModeBtn').classList.toggle('active', mode === 'voice');
            document.getElementById('chatContainer').style.display = mode === 'message' ? 'flex' : 'none';
            document.getElementById('chatContainer').style.flexDirection = 'column';
            document.getElementById('inputArea').style.display = mode === 'message' ? 'flex' : 'none';
            document.getElementById('voiceArea').classList.toggle('show', mode === 'voice');

            if (mode === 'voice') initSpeechRecognition();
            if (mode === 'message' && isRecording) stopRecording();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Message Mode
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addMessage(text, type, meta = null) {
            const emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.style.display = 'none';

            const chat = document.getElementById('chatContainer');
            const typing = document.getElementById('typingIndicator');
            const div = document.createElement('div');
            div.className = `msg ${type}`;

            let metaHtml = '';
            if (meta) {
                const parts = [];
                if (meta.scam_type && meta.scam_type !== 'unknown') parts.push(`type: ${meta.scam_type}`);
                if (meta.confidence) parts.push(`conf: ${(meta.confidence * 100).toFixed(0)}%`);
                if (meta.urgency_level) parts.push(`urgency: ${meta.urgency_level}`);
                if (parts.length) metaHtml = `<div class="msg-meta">${parts.join(' Â· ')}</div>`;
            }

            const agentLabel = type === 'scammer' ? 'ğŸ”´ Scammer (You)' : `ğŸŸ¢ ${persona.name} (Honeypot)`;

            div.innerHTML = `
                <div class="msg-label">${agentLabel}</div>
                <div class="msg-text">${escapeHtml(text)}</div>
                ${metaHtml}
            `;

            chat.insertBefore(div, typing);
            chat.scrollTop = chat.scrollHeight;
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        async function sendMessage(overrideText = null) {
            const input = document.getElementById('msgInput');
            const text = overrideText || input.value.trim();
            if (!text) return;
            if (!overrideText) input.value = '';

            addMessage(text, 'scammer');
            messageCount++;
            updateStats();

            const typing = document.getElementById('typingIndicator');
            typing.classList.add('show');

            try {
                const resp = await fetch(`${API_BASE}/api/honeypot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
                    body: JSON.stringify({
                        sessionId,
                        message: { sender: 'scammer', text },
                        conversationHistory,
                        persona: persona, // Send dynamic persona
                        metadata: {},
                    }),
                });

                const data = await resp.json();
                typing.classList.remove('show');

                const reply = data.reply || 'Sorry, network issue...';
                const analysis = data.analysis || {};

                addMessage(reply, 'agent', analysis);

                conversationHistory.push({ sender: 'scammer', text });
                conversationHistory.push({ sender: 'agent', text: reply });
                messageCount = data.totalMessagesExchanged || messageCount;

                updateStats(data);
                updateIntel(data.extractedIntelligence, data.intelligence ? data.intelligence.extracted : []);

                return reply;

            } catch (err) {
                typing.classList.remove('show');
                console.error(err);
                addMessage('âš ï¸ Connection error. Is the server running?', 'agent');
                return null;
            }
        }

        function updateStats(data) {
            document.getElementById('msgCount').textContent = messageCount;
            if (data) {
                const a = data.analysis || {};
                const isScam = data.scamDetected;
                const conf = a.scam_confidence;
                const stype = a.scam_type;

                // Always update â€” use accumulated session values
                if (isScam) {
                    document.getElementById('scamStatus').textContent = 'âœ… Detected';
                    document.getElementById('scamStatus').style.color = 'var(--success)';
                } else if (conf && conf > 0) {
                    document.getElementById('scamStatus').textContent = 'â³ Analyzing';
                    document.getElementById('scamStatus').style.color = 'var(--accent)';
                }

                if (conf !== undefined && conf !== null) {
                    const pct = (conf * 100).toFixed(0);
                    document.getElementById('confVal').textContent = `${pct}%`;
                    // Color code confidence
                    const confEl = document.getElementById('confVal');
                    if (conf >= 0.7) confEl.style.color = 'var(--danger)';
                    else if (conf >= 0.4) confEl.style.color = 'var(--accent)';
                    else confEl.style.color = 'var(--text-primary)';
                }

                if (stype && stype !== 'unknown') {
                    document.getElementById('scamType').textContent = stype;
                    document.getElementById('scamType').style.color = 'var(--accent)';
                }
            }
        }

        function updateIntel(intel, rawIntel) {
            if (!intel) return;
            const panel = document.getElementById('intelPanel');
            const grid = document.getElementById('intelGrid');
            const items = [];

            const labels = {
                bankAccounts: 'ğŸ¦', upiIds: 'ğŸ’³', phoneNumbers: 'ğŸ“',
                phishingLinks: 'ğŸ”—', suspiciousKeywords: 'âš ï¸',
                employee_id: 'ğŸ†”', reference_id: 'ğŸ”–', policy_id: 'ğŸ“„'
            };

            for (const [key, values] of Object.entries(intel)) {
                if (!values || !values.length) continue;
                const icon = labels[key] || 'ğŸ“‹';
                values.forEach(v => {
                    items.push(`<span class="intel-tag">${icon} ${escapeHtml(v)}</span>`);
                });
            }

            if (items.length) {
                grid.innerHTML = items.join('');
                panel.classList.add('show');
            }

            // Update JSON Intelligence Panel
            updateJsonIntel(intel, rawIntel);
        }

        function updateJsonIntel(intel, rawIntel) {
            const jsonPanel = document.getElementById('jsonIntelPanel');
            const jsonContent = document.getElementById('jsonIntelContent');

            // Build comprehensive JSON from all available data
            const jsonData = {
                extractedIntelligence: intel || {},
                rawItems: rawIntel || [],
                sessionSummary: {
                    totalMessages: messageCount,
                    sessionId: sessionId,
                    timestamp: new Date().toISOString()
                }
            };

            // Only show if there's meaningful data
            const hasData = Object.values(intel || {}).some(v => Array.isArray(v) && v.length > 0)
                || (rawIntel && rawIntel.length > 0);

            if (hasData) {
                jsonContent.textContent = JSON.stringify(jsonData, null, 2);
                jsonPanel.classList.add('show');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // End Session â€” Save to Database
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function endSession() {
            if (conversationHistory.length === 0) {
                showToast('No conversation to save.', 'warn');
                return;
            }

            if (!confirm('End this session and save all data to the database?')) return;

            const btn = document.getElementById('endSessionBtn');
            btn.disabled = true;
            btn.textContent = 'â³';

            try {
                const resp = await fetch(`${API_BASE}/api/session/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, persona }),
                });

                const data = await resp.json();

                if (resp.ok && data.status === 'success') {
                    showToast('âœ… Session saved! ' + data.summary.message_count + ' messages stored.', 'success');

                    // Reset for new session
                    sessionId = 'session-' + Date.now();
                    conversationHistory = [];
                    messageCount = 0;

                    const firstName = persona.name.split(' ')[0];
                    document.getElementById('chatContainer').innerHTML = `
                        <div class="empty-state" id="emptyState">
                            <div class="empty-icon">ğŸ•µï¸</div>
                            <div class="empty-text">
                                Session saved! Start a new conversation.<br>
                                The AI honeypot (<span id="agentNameDisplay">${firstName}</span>) is ready.
                            </div>
                            <div class="empty-hint">Try: "Your ${persona.bank} account has been compromised"</div>
                        </div>
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="msg-label" style="color: var(--success);"><span id="typingName">${firstName}</span> is typing...</div>
                            <div class="typing-dots"><span></span><span></span><span></span></div>
                        </div>
                    `;

                    // Reset stats display
                    document.getElementById('msgCount').textContent = '0';
                    document.getElementById('scamStatus').textContent = 'â€”';
                    document.getElementById('scamStatus').style.color = '';
                    document.getElementById('confVal').textContent = 'â€”';
                    document.getElementById('confVal').style.color = '';
                    document.getElementById('scamType').textContent = 'â€”';
                    document.getElementById('scamType').style.color = '';

                    // Reset intel panels
                    document.getElementById('intelPanel').classList.remove('show');
                    document.getElementById('intelGrid').innerHTML = '';
                    document.getElementById('jsonIntelPanel').classList.remove('show');
                    document.getElementById('jsonIntelContent').textContent = 'No data yet...';
                } else {
                    showToast('âš ï¸ ' + (data.detail || 'Failed to save session'), 'error');
                }
            } catch (e) {
                console.error('End session error:', e);
                showToast('âš ï¸ Connection error. Is the server running?', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'â¹';
            }
        }

        function showToast(msg, type = 'success') {
            // Create a quick toast notification
            let toast = document.getElementById('toastNotif');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotif';
                toast.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:14px 22px;border-radius:12px;font-size:13px;font-weight:500;z-index:200;transform:translateY(100px);opacity:0;transition:all 0.3s;font-family:Inter,sans-serif;';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.background = type === 'error' ? 'rgba(239,68,68,0.9)' :
                                     type === 'warn' ? 'rgba(245,158,11,0.9)' :
                                     'rgba(34,197,94,0.9)';
            toast.style.color = type === 'error' ? '#fff' : '#000';
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.transform = 'translateY(100px)'; toast.style.opacity = '0'; }, 3500);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Voice Mode â€” Web Speech API
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function initSpeechRecognition() {
            if (recognition) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voiceStatus').textContent = 'âŒ Speech recognition not supported in this browser. Use Chrome.';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onresult = (e) => {
                let text = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    text += e.results[i][0].transcript;
                }
                document.getElementById('voiceTranscript').textContent = text;

                if (e.results[e.results.length - 1].isFinal) {
                    handleVoiceInput(text.trim());
                }
            };

            recognition.onend = () => {
                if (isRecording) {
                    isRecording = false;
                    document.getElementById('micBtn').classList.remove('recording');
                    document.getElementById('voiceStatus').textContent = 'Processing...';
                }
            };

            recognition.onerror = (e) => {
                console.error('Speech error:', e.error);
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                if (e.error === 'not-allowed') {
                    document.getElementById('voiceStatus').textContent = 'âŒ Microphone access denied. Allow mic in browser settings.';
                } else {
                    document.getElementById('voiceStatus').textContent = `Error: ${e.error}. Tap mic to retry.`;
                }
            };
        }

        function toggleMic() {
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
                document.getElementById('micBtn').classList.remove('speaking');
                document.getElementById('voiceStatus').textContent = 'Tap the mic to start speaking';
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) initSpeechRecognition();
            if (!recognition) return;

            isRecording = true;
            document.getElementById('micBtn').classList.add('recording');
            document.getElementById('voiceStatus').textContent = 'ğŸ”´ Listening... Speak now';
            document.getElementById('voiceTranscript').innerHTML = '<span style="color: var(--text-muted)">Listening...</span>';

            try {
                recognition.start();
            } catch (e) {
                // Already started
            }
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            if (recognition) recognition.stop();
        }

        async function handleVoiceInput(text) {
            if (!text) {
                document.getElementById('voiceStatus').textContent = 'No speech detected. Tap mic to retry.';
                return;
            }

            document.getElementById('voiceStatus').textContent = 'â³ Getting honeypot response...';
            document.getElementById('voiceTranscript').innerHTML =
                `<div style="color: var(--danger); margin-bottom: 8px; font-weight: 500;">ğŸ”´ You said:</div>${escapeHtml(text)}`;

            // Also add to chat
            addMessage(text, 'scammer');
            messageCount++;

            try {
                const resp = await fetch(`${API_BASE}/api/honeypot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
                    body: JSON.stringify({
                        sessionId,
                        message: { sender: 'scammer', text },
                        conversationHistory,
                        persona: persona, // Send dynamic persona
                        metadata: {},
                    }),
                });

                const data = await resp.json();
                const reply = data.reply || 'Sorry, network issue...';
                const analysis = data.analysis || {};

                conversationHistory.push({ sender: 'scammer', text });
                conversationHistory.push({ sender: 'agent', text: reply });
                messageCount = data.totalMessagesExchanged || messageCount;

                addMessage(reply, 'agent', analysis);
                updateStats(data);
                updateIntel(data.extractedIntelligence, data.intelligence ? data.intelligence.extracted : []);

                const firstName = persona.name.split(' ')[0];

                // Speak the reply
                document.getElementById('voiceTranscript').innerHTML =
                    `<div style="color: var(--danger); margin-bottom: 8px; font-weight: 500;">ğŸ”´ You:</div>${escapeHtml(text)}` +
                    `<div style="color: var(--success); margin-bottom: 8px; margin-top: 12px; font-weight: 500;">ğŸŸ¢ ${firstName}:</div>${escapeHtml(reply)}`;

                speakReply(reply);

            } catch (err) {
                document.getElementById('voiceStatus').textContent = 'âš ï¸ Connection error. Tap mic to retry.';
            }
        }

        async function speakReply(text) {
            isSpeaking = true;
            document.getElementById('micBtn').classList.add('speaking');
            const firstName = persona.name.split(' ')[0];
            document.getElementById('voiceStatus').textContent = `ğŸŸ¢ ${firstName} is speaking...`;

            try {
                // Try ElevenLabs first
                const resp = await fetch(`${API_BASE}/api/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, gender: persona.gender || 'Male' }),
                });

                const ttsStatus = resp.headers.get('X-TTS-Status');
                if (resp.ok && ttsStatus === 'ok') {
                    const blob = await resp.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);

                    audio.onended = () => {
                        isSpeaking = false;
                        document.getElementById('micBtn').classList.remove('speaking');
                        document.getElementById('voiceStatus').textContent = 'Tap the mic to continue the conversation';
                        URL.revokeObjectURL(audioUrl);
                    };
                    audio.onerror = () => {
                        console.warn('ElevenLabs audio playback failed, falling back to browser TTS');
                        speakWithBrowser(text);
                    };
                    audio.play();
                    return;
                }
            } catch (e) {
                console.warn('ElevenLabs TTS failed:', e);
            }

            // Fallback to browser speech synthesis
            speakWithBrowser(text);
        }

        function speakWithBrowser(text) {
            if (!('speechSynthesis' in window)) {
                isSpeaking = false;
                document.getElementById('micBtn').classList.remove('speaking');
                document.getElementById('voiceStatus').textContent = 'Speech synthesis not supported.';
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            utterance.rate = 0.95;
            utterance.pitch = 1.1;

            const voices = speechSynthesis.getVoices();
            const genderPref = persona.gender || 'Male';
            const voiceMatch = voices.find(v => v.lang === 'en-IN' && v.name.includes(genderPref))
                || voices.find(v => v.lang === 'en-IN')
                || voices.find(v => v.lang.startsWith('en') && v.name.includes(genderPref))
                || voices.find(v => v.lang.startsWith('en'));
            if (voiceMatch) utterance.voice = voiceMatch;

            utterance.onend = () => {
                isSpeaking = false;
                document.getElementById('micBtn').classList.remove('speaking');
                document.getElementById('voiceStatus').textContent = 'Tap the mic to continue the conversation';
            };
            utterance.onerror = () => {
                isSpeaking = false;
                document.getElementById('micBtn').classList.remove('speaking');
                document.getElementById('voiceStatus').textContent = 'Tap mic to speak again';
            };

            speechSynthesis.speak(utterance);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Event Listeners
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('msgInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Preload voices
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }

        // Focus input
        document.getElementById('msgInput').focus();
    </script>
</body>

</html>